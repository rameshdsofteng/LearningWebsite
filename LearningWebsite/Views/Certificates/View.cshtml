@model LearningWebsite.Models.Certificate
@{
    ViewData["Title"] = "Certificate - " + Model.LearningTitle;
}

@section Styles {
    <link rel="stylesheet" href="~/css/certificates.css" asp-append-version="true" />

    <!-- SIMPLIFIED PRINT STYLES FOR GUARANTEED COMPATIBILITY -->
    <style id="certificate-print-styles">
        /* Screen styles */
        @@media screen {
            .certificate-view-container {
                background: #f8f9fa;
                min-height: 100vh;
                padding: 40px 0;
            }
        }

        /* ONE-PAGE PRINT STYLES - NO OVERFLOW */
        @@media print {
            @@page { 
                size: A4 landscape; 
                margin: 6mm; 
            }

            /* Reset */
            * { 
                box-sizing: border-box; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
            }

            body { 
                background: white; 
                font-family: Arial, sans-serif; 
                margin: 0; 
                padding: 0; 
                color: black; 
                overflow: hidden;
            }

            /* Hide UI elements */
            .certificate-actions-bottom, nav, header, footer, 
            button, .btn, .dropdown, .toast, #shareToast { 
                display: none; 
            }

            /* Certificate container - NO OVERFLOW */
            .certificate-view-container { 
                display: block; 
                background: white; 
                width: 100%; 
                padding: 0; 
                margin: 0; 
                overflow: hidden;
                page-break-after: avoid;
            }

            .certificate-view-container .container { 
                max-width: 100%; 
                width: 100%; 
                padding: 0; 
                margin: 0; 
                overflow: hidden;
            }

            .certificate-display { 
                display: block; 
                width: 100%; 
                background: white; 
                padding: 0; 
                margin: 0; 
                box-shadow: none; 
                overflow: hidden;
                page-break-after: avoid;
            }

            /* Certificate border - CONTROLLED HEIGHT */
            .certificate-border { 
                border: 2.5px solid #667eea; 
                padding: 8mm; 
                margin: 0 auto; 
                max-width: 100%; 
                max-height: 185mm;
                background: white; 
                position: relative; 
                page-break-inside: avoid;
                page-break-after: avoid;
                overflow: hidden;
            }

            .certificate-inner { 
                text-align: center; 
                padding: 4mm; 
                overflow: hidden;
            }

            /* Header - BALANCED */
            .cert-header { 
                margin-bottom: 5mm; 
                text-align: center; 
            }

            .cert-logo { 
                font-size: 8mm; 
                color: #667eea; 
                margin-bottom: 2mm; 
            }

            .cert-main-title { 
                font-size: 7mm; 
                font-weight: bold; 
                color: black; 
                margin: 1mm 0; 
                text-transform: uppercase; 
                letter-spacing: 1mm;
            }

            .cert-subtitle { 
                font-size: 3mm; 
                color: #666; 
                margin-bottom: 4mm; 
            }

            /* Body - BALANCED */
            .cert-body { 
                margin: 5mm 0; 
                text-align: center; 
            }

            .cert-presented-to, .cert-has-completed { 
                font-size: 3mm; 
                color: #666; 
                margin: 1.5mm 0; 
            }

            .cert-recipient-name { 
                font-size: 9mm; 
                font-weight: bold; 
                color: black; 
                margin: 3mm 0; 
                font-family: Georgia, serif; 
            }

            .cert-course-name { 
                font-size: 6mm; 
                font-weight: bold; 
                color: #667eea; 
                margin: 3mm 0; 
            }

            .cert-description { 
                font-size: 2.5mm; 
                color: #666; 
                margin: 2mm auto; 
                max-width: 120mm; 
                line-height: 1.3; 
            }

            /* Score - BALANCED */
            .cert-score-display { 
                margin: 5mm 0; 
                text-align: center; 
            }

            .score-circle-large { 
                width: 18mm; 
                height: 18mm; 
                border-radius: 50%; 
                background: #10b981; 
                color: white; 
                display: inline-flex; 
                align-items: center; 
                justify-content: center; 
                font-size: 5mm; 
                font-weight: bold; 
                margin: 0 auto 2mm auto; 
            }

            .score-label { 
                font-size: 2mm; 
                color: #666; 
                font-weight: bold; 
                text-transform: uppercase; 
            }

            /* Footer - BALANCED */
            .cert-footer { 
                border-top: 1px solid #ccc; 
                padding-top: 3mm; 
                margin-top: 5mm; 
                text-align: center; 
            }

            .cert-footer-row { 
                display: flex; 
                justify-content: space-around; 
                margin-bottom: 3mm; 
            }

            .cert-footer-item { 
                text-align: center; 
            }

            .cert-footer-label { 
                font-size: 2mm; 
                color: #666; 
                text-transform: uppercase; 
                margin-bottom: 0.5mm; 
            }

            .cert-footer-value { 
                font-size: 2.5mm; 
                color: black; 
                font-weight: bold; 
            }

            .cert-seal { 
                background: #667eea; 
                color: white; 
                padding: 2mm 6mm; 
                border-radius: 3mm; 
                font-size: 2.5mm; 
                font-weight: bold; 
                display: inline-flex; 
                align-items: center; 
                gap: 1mm; 
            }

            /* Corners - BALANCED */
            .certificate-corner { 
                position: absolute; 
                width: 6mm; 
                height: 6mm; 
                border: 1.5px solid #f59e0b; 
            }

            .corner-tl { top: -1px; left: -1px; border-right: none; border-bottom: none; }
            .corner-tr { top: -1px; right: -1px; border-left: none; border-bottom: none; }
            .corner-bl { bottom: -1px; left: -1px; border-right: none; border-top: none; }
            .corner-br { bottom: -1px; right: -1px; border-left: none; border-top: none; }
        }
    </style>
}

<div class="certificate-view-container">
    <div class="container mt-4">
        <!-- Certificate Display -->
        <div class="certificate-display" id="certificateDisplay">
            <div class="certificate-border">
                <div class="certificate-corner corner-tl"></div>
                <div class="certificate-corner corner-tr"></div>
                <div class="certificate-corner corner-bl"></div>
                <div class="certificate-corner corner-br"></div>

                <div class="certificate-inner">
                    <!-- Header -->
                    <div class="cert-header">
                        <div class="cert-logo">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <h1 class="cert-main-title">Certificate of Completion</h1>
                        <div class="cert-subtitle">Learning Platform</div>
                    </div>

                    <!-- Body -->
                    <div class="cert-body">
                        <p class="cert-presented-to">This is to certify that</p>
                        <h2 class="cert-recipient-name">@Model.EmployeeName</h2>
                        <p class="cert-has-completed">has successfully completed</p>
                        <h3 class="cert-course-name">@Model.LearningTitle</h3>
                        <p class="cert-description">@Model.Description</p>

                        <div class="cert-score-display">
                            <div class="score-badge-large">
                                <div class="score-circle-large">
                                    @Model.Score.ToString("F1")%
                                </div>
                                <div class="score-label">Achievement Score</div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="cert-footer">
                        <div class="cert-footer-row">
                            <div class="cert-footer-item">
                                <div class="cert-footer-label">Certificate Number</div>
                                <div class="cert-footer-value">@Model.CertificateNumber</div>
                            </div>
                            <div class="cert-footer-item">
                                <div class="cert-footer-label">Date of Issue</div>
                                <div class="cert-footer-value">@Model.IssuedDate.ToString("MMMM dd, yyyy")</div>
                            </div>
                        </div>
                        <div class="cert-seal">
                            <i class="fas fa-award"></i>
                            <span>Verified</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="certificate-actions-bottom">
            <button onclick="window.print()" class="btn btn-primary btn-lg">
                <i class="fas fa-print"></i> Print Certificate
            </button>

            <!-- Share Button with Dropdown -->
            <div class="btn-group">
                <button type="button" class="btn btn-success btn-lg dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-share-alt"></i> Share Certificate
                </button>
                <ul class="dropdown-menu share-menu">
                    <li>
                        <a class="dropdown-item share-item" href="#" onclick="shareOnLinkedIn(); return false;">
                            <i class="fab fa-linkedin"></i> Share on LinkedIn
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item share-item" href="#" onclick="shareOnTwitter(); return false;">
                            <i class="fab fa-twitter"></i> Share on Twitter
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item share-item" href="#" onclick="shareViaEmail(); return false;">
                            <i class="fas fa-envelope"></i> Share via Email
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item share-item" href="#" onclick="copyCertificateNumber(); return false;">
                            <i class="fas fa-hashtag"></i> Copy Certificate Number
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item share-item" href="#" onclick="copyShareLink(); return false;">
                            <i class="fas fa-link"></i> Copy Shareable Link
                        </a>
                    </li>
                </ul>
            </div>

            <a asp-action="Index" class="btn btn-secondary btn-lg">
                <i class="fas fa-arrow-left"></i> Back to Certificates
            </a>
            <a asp-controller="Employee" asp-action="Index" class="btn btn-outline-secondary btn-lg">
                <i class="fas fa-home"></i> Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Success Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="shareToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Success!</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Copied to clipboard!
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Certificate data
        const certificateData = {
            number: '@Model.CertificateNumber',
            title: '@Model.LearningTitle',
            name: '@Model.EmployeeName',
            score: '@Model.Score.ToString("F1")',
            date: '@Model.IssuedDate.ToString("MMMM dd, yyyy")',
            url: window.location.href
        };

        // Share on LinkedIn
        function shareOnLinkedIn() {
            const text = `I'm proud to share that I've earned a certificate in ${certificateData.title} with a score of ${certificateData.score}%! ðŸŽ“`;
            const url = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(certificateData.url)}`;
            window.open(url, '_blank', 'width=600,height=600');
        }

        // Share on Twitter/X
        function shareOnTwitter() {
            const text = `I just earned a certificate in ${certificateData.title} with ${certificateData.score}%! ðŸŽ“ #LearningPlatform #Certificate`;
            const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(certificateData.url)}`;
            window.open(url, '_blank', 'width=600,height=400');
        }

        // Share via Email
        function shareViaEmail() {
            const subject = `Certificate Achievement: ${certificateData.title}`;
            const body = `Hello,%0D%0A%0D%0AI'm excited to share that I've earned a certificate!%0D%0A%0D%0ACertificate Details:%0D%0A- Course: ${certificateData.title}%0D%0A- Score: ${certificateData.score}%%0D%0A- Date: ${certificateData.date}%0D%0A- Certificate Number: ${certificateData.number}%0D%0A%0D%0AView Certificate: ${certificateData.url}%0D%0A%0D%0ABest regards,%0D%0A${certificateData.name}`;
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        // Copy Certificate Number
        function copyCertificateNumber() {
            copyToClipboard(certificateData.number, 'Certificate number copied to clipboard!');
        }

        // Copy Shareable Link
        function copyShareLink() {
            copyToClipboard(certificateData.url, 'Certificate link copied to clipboard!');
        }

        // Helper function to copy to clipboard
        function copyToClipboard(text, message) {
            navigator.clipboard.writeText(text).then(function() {
                showToast(message);
            }, function(err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast(message);
            });
        }

        // Show toast notification
        function showToast(message) {
            document.getElementById('toastMessage').textContent = message;
            const toastEl = document.getElementById('shareToast');
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        // Print-specific handlers - optimized for landscape orientation
        window.addEventListener('beforeprint', function() {
            console.log('Print initiated - Certificate ready for printing');
            document.body.classList.add('printing');

            // Ensure all fonts are loaded before printing
            document.fonts.ready.then(() => {
                console.log('All fonts loaded - Print ready');
            });
        });

        window.addEventListener('afterprint', function() {
            console.log('Print completed successfully');
            document.body.classList.remove('printing');
        });
    </script>
}
